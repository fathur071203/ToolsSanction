{% extends "base.html" %} {% block content %}
<div class="row">
  <div class="col">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Screening Jobs</h2>
      <button
        class="btn btn-outline-primary btn-sm"
        onclick="location.reload()"
      >
        ↻ Refresh Data
      </button>
    </div>

    {% if jobs %}
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Batch</th>
            <th>Status</th>
            <th style="width: 20%">Progress</th>
            <th>Transaksi</th>
            <th>Matches</th>
            <th>Started</th>
            <th>Finished</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for j in jobs %} {% set is_finished = j.status == 'SUCCESS' or
          j.status == 'DONE' %} {% set bar_width = 100 if is_finished else
          (j.progress_percentage or 0) %} {% set bar_class = 'bg-success' if
          is_finished else ('progress-bar-animated bg-warning' if j.status ==
          'RUNNING' else 'bg-secondary') %}

          <tr
            data-job-id="{{ j.id }}"
            data-status="{{ j.status }}"
            class="job-row"
          >
            <td><strong>#{{ j.id }}</strong></td>
            <td>Batch #{{ j.batch_id }}</td>
            <td>
              {% if j.status == 'SUCCESS' %}
              <span class="badge bg-success">SUCCESS</span>
              {% elif j.status == 'FAILURE' %}
              <span class="badge bg-danger">FAILURE</span>
              {% elif j.status == 'RUNNING' %}
              <span class="badge bg-warning text-dark">RUNNING</span>
              {% else %}
              <span class="badge bg-secondary">{{ j.status }}</span>
              {% endif %}
            </td>
            <td>
              <div
                class="progress"
                style="height: 20px; background-color: #e2e8f0"
              >
                <div
                  class="progress-bar progress-bar-striped {{ bar_class }}"
                  role="progressbar"
                  style="--bar-width: {{ bar_width }}%; width: var(--bar-width);"
                  aria-valuenow="{{ bar_width }}"
                  aria-valuemin="0"
                  aria-valuemax="100"
                >
                  <span class="progress-text small fw-bold">
                    {{ "%.0f"|format(bar_width) }}%
                  </span>
                </div>
              </div>
            </td>
            <td class="transactions-info">
              <span class="processed fw-bold">
                {{ j.total_transactions if is_finished else
                (j.processed_transactions or 0) }}
              </span>
              <span class="text-muted small">/</span>
              <span class="total text-muted small"
                >{{ j.total_transactions or 0 }}</span
              >
            </td>

            <td class="matches-count fw-bold text-danger">
              {{ j.total_matches or 0 }}
            </td>
            <td class="small text-muted">
              {{ j.started_at.strftime('%Y-%m-%d %H:%M') if j.started_at else
              '-' }}
            </td>
            <td class="small text-muted">
              {{ j.finished_at.strftime('%Y-%m-%d %H:%M') if j.finished_at else
              '-' }}
            </td>
            <td>
              {% if j.status == 'SUCCESS' %}
              <a
                href="{{ url_for('web.screening_job_detail', job_id=j.id) }}"
                class="btn btn-sm btn-primary"
              >
                Lihat Hasil
              </a>
              {% elif j.status == 'FAILURE' %}
              <button class="btn btn-sm btn-outline-danger" disabled>
                Error
              </button>
              {% else %}
              <button class="btn btn-sm btn-outline-secondary" disabled>
                Processing...
              </button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info d-flex align-items-center">
      <div class="me-2">ℹ️</div>
      <div>
        Belum ada screening job.
        <a href="{{ url_for('web.sanctions_upload') }}" class="alert-link"
          >Mulai screening baru</a
        >.
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const runningRows = document.querySelectorAll('tr[data-status="RUNNING"]');
    const jobIds = Array.from(runningRows).map((row) => row.dataset.jobId);

    if (jobIds.length > 0) {
      console.log("Monitoring jobs:", jobIds);

      const pollInterval = setInterval(() => {
        jobIds.forEach((jobId) => {
          fetch(`/api/screening/jobs/${jobId}/progress`)
            .then((response) => {
              if (!response.ok) {
                console.error("Fetch error:", response.status);
                return null;
              }
              return response.json();
            })
            .then((data) => {
              if (!data) return;

              // --- DEBUGGING: Lihat isi data di Console Browser ---
              console.log(`Job ${jobId} Data:`, data);
              // ----------------------------------------------------

              const row = document.querySelector(`tr[data-job-id="${jobId}"]`);
              if (!row) return;

              // 1. Logika Penentuan Persentase (Fallback agar aman)
              // Backend mungkin mengirim 'percent' (dari Redis) atau 'progress_percentage' (dari DB)
              let rawPercent = data.percent;
              if (rawPercent === undefined || rawPercent === null) {
                rawPercent = data.progress_percentage;
              }
              const pct = Math.round(rawPercent || 0);

              // 2. Update Progress Bar Visual
              const progressBar = row.querySelector(".progress-bar");
              const progressText = row.querySelector(".progress-text");

              if (progressBar) {
                progressBar.style.width = `${pct}%`;
                progressBar.setAttribute("aria-valuenow", pct);

                // Hapus class 'bg-warning' jika sudah selesai (opsional)
                if (pct >= 100) {
                  progressBar.classList.remove("bg-warning");
                  progressBar.classList.add("bg-success");
                }
              }

              if (progressText) {
                progressText.textContent = `${pct}%`;
              }

              // 3. Update Angka Teks
              const processedSpan = row.querySelector(".processed");
              const totalSpan = row.querySelector(".total");
              const matchesCell = row.querySelector(".matches-count");

              // Gunakan fallback 'processed_transactions' jika 'processed' kosong
              if (processedSpan)
                processedSpan.textContent =
                  data.processed ?? data.processed_transactions ?? 0;
              if (totalSpan)
                totalSpan.textContent =
                  data.total ?? data.total_transactions ?? 0;
              if (matchesCell)
                matchesCell.textContent =
                  data.matches ?? data.total_matches ?? 0;

              // 4. Auto Reload jika Status Berubah (Selesai/Gagal)
              // Kita cek jika status data berbeda dengan status di atribut HTML awal
              if (data.status === "SUCCESS" || data.status === "FAILURE") {
                console.log(
                  `Job ${jobId} finished with status ${data.status}. Reloading...`
                );
                clearInterval(pollInterval);
                setTimeout(() => location.reload(), 1000);
              }
            })
            .catch((error) => {
              console.error(`Network Error job ${jobId}:`, error);
            });
        });
      }, 500);

      window.addEventListener("beforeunload", () => {
        clearInterval(pollInterval);
      });
    }
  });
</script>
{% endblock %}
