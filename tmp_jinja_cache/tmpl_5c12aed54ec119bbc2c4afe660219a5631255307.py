from jinja2.runtime import LoopContext, Macro, Markup, Namespace, TemplateNotFound, TemplateReference, TemplateRuntimeError, Undefined, escape, identity, internalcode, markup_join, missing, str_join
name = 'sanctions_upload.html'

def root(context, missing=missing):
    resolve = context.resolve_or_missing
    undefined = environment.undefined
    concat = environment.concat
    cond_expr_undefined = Undefined
    if 0: yield None
    parent_template = None
    pass
    parent_template = environment.get_template('base.html', 'sanctions_upload.html')
    for name, parent_block in parent_template.blocks.items():
        context.blocks.setdefault(name, []).append(parent_block)
    yield from parent_template.root_render_func(context)

def block_head(context, missing=missing):
    resolve = context.resolve_or_missing
    undefined = environment.undefined
    concat = environment.concat
    cond_expr_undefined = Undefined
    if 0: yield None
    _block_vars = {}
    pass
    yield '\n<style>\n  /* Premium multi-step form with progress indicator and modern styling */\n  .form-container {\n    max-width: 600px;\n    margin: 0 auto;\n  }\n\n  .progress-header {\n    margin-bottom: 2rem;\n  }\n\n  .progress-title h1 {\n    font-size: 1.75rem;\n    font-weight: 700;\n    color: var(--text-primary);\n    margin-bottom: 0.5rem;\n  }\n\n  .progress-title p {\n    color: var(--text-secondary);\n    font-size: 0.95rem;\n  }\n\n  /* Progress Bar UI Steps (Top Indicator) */\n  .progress-indicator {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 2rem;\n    position: relative;\n  }\n\n  .progress-indicator::before {\n    content: \'\';\n    position: absolute;\n    top: 20px;\n    left: 0;\n    right: 0;\n    height: 2px;\n    background-color: var(--border);\n    z-index: 0;\n  }\n\n  .progress-step {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    flex: 1;\n    position: relative;\n    z-index: 1;\n  }\n\n  .progress-step.completed::before {\n    background-color: var(--primary-accent);\n  }\n\n  .step-dot {\n    width: 40px;\n    height: 40px;\n    border-radius: 50%;\n    background-color: var(--border);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-weight: 600;\n    color: var(--text-light);\n    margin-bottom: 0.75rem;\n    transition: all 0.3s ease;\n  }\n\n  .progress-step.active .step-dot {\n    background-color: var(--primary-accent);\n    color: white;\n    box-shadow: 0 0 0 8px rgba(14, 165, 233, 0.1);\n    font-size: 1.2rem;\n  }\n\n  .progress-step.completed .step-dot {\n    background-color: var(--success);\n    color: white;\n  }\n\n  .step-label {\n    font-size: 0.8rem;\n    font-weight: 500;\n    color: var(--text-secondary);\n    text-align: center;\n  }\n\n  .progress-step.active .step-label {\n    color: var(--text-primary);\n    font-weight: 600;\n  }\n\n  /* Form Card */\n  .form-card {\n    background-color: var(--surface);\n    border: 1px solid var(--border);\n    border-radius: 12px;\n    padding: 2rem;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);\n    margin-bottom: 2rem;\n  }\n\n  .form-section-title {\n    font-size: 1.25rem;\n    font-weight: 600;\n    color: var(--text-primary);\n    margin-bottom: 1.5rem;\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n  }\n\n  .form-section-icon {\n    width: 32px;\n    height: 32px;\n    background-color: rgba(14, 165, 233, 0.1);\n    border-radius: 6px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.2rem;\n  }\n\n  .form-group {\n    margin-bottom: 1.5rem;\n  }\n\n  .form-group:last-child {\n    margin-bottom: 0;\n  }\n\n  .form-label {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    margin-bottom: 0.75rem;\n    font-weight: 500;\n  }\n\n  .label-required {\n    color: var(--danger);\n    font-weight: 700;\n  }\n\n  .label-optional {\n    color: var(--text-light);\n    font-size: 0.85rem;\n  }\n\n  .form-control, .form-select {\n    font-size: 0.95rem;\n  }\n\n  .form-text {\n    margin-top: 0.5rem;\n  }\n\n  /* File Upload Area */\n  .file-upload-area {\n    border: 2px dashed var(--primary-accent);\n    border-radius: 8px;\n    padding: 2rem;\n    text-align: center;\n    background-color: rgba(14, 165, 233, 0.03);\n    cursor: pointer;\n    transition: all 0.2s ease;\n  }\n\n  .file-upload-area:hover {\n    background-color: rgba(14, 165, 233, 0.08);\n    border-color: #0284c7;\n  }\n\n  .file-upload-area input[type="file"] {\n    display: none;\n  }\n\n  .file-upload-icon {\n    font-size: 2.5rem;\n    margin-bottom: 0.75rem;\n  }\n\n  .file-upload-text {\n    color: var(--text-primary);\n    font-weight: 500;\n    margin-bottom: 0.25rem;\n  }\n\n  .file-upload-hint {\n    color: var(--text-light);\n    font-size: 0.85rem;\n  }\n\n  /* Form Actions */\n  .form-actions {\n    display: flex;\n    gap: 1rem;\n    justify-content: space-between;\n    margin-top: 2rem;\n  }\n\n  .form-actions .btn {\n    flex: 1;\n    padding: 0.75rem 1.5rem;\n  }\n\n  .btn-cancel {\n    background-color: transparent;\n    border: 1px solid var(--border);\n    color: var(--text-primary);\n  }\n\n  .btn-cancel:hover {\n    background-color: var(--background);\n    border-color: var(--text-light);\n  }\n\n  /* Info Box */\n  .info-box {\n    background-color: rgba(14, 165, 233, 0.05);\n    border-left: 4px solid var(--primary-accent);\n    border-radius: 6px;\n    padding: 1rem;\n    margin-bottom: 1.5rem;\n    color: var(--text-primary);\n    font-size: 0.9rem;\n    line-height: 1.6;\n  }\n\n  .info-box strong {\n    display: block;\n    margin-bottom: 0.5rem;\n    font-weight: 600;\n  }\n\n  .info-box ul {\n    margin: 0;\n    padding-left: 1.25rem;\n  }\n\n  .info-box li {\n    margin-bottom: 0.25rem;\n  }\n\n  /* Responsive */\n  @media (max-width: 768px) {\n    .form-card {\n      padding: 1.5rem;\n    }\n\n    .progress-indicator {\n      margin-bottom: 1.5rem;\n    }\n\n    .step-label {\n      font-size: 0.75rem;\n    }\n\n    .form-actions {\n      flex-direction: column;\n    }\n\n    .form-actions .btn {\n      width: 100%;\n    }\n  }\n\n  /* Added styles for source selection cards */\n  .source-option-card {\n    border: 2px solid var(--border);\n    border-radius: 12px;\n    padding: 1.5rem;\n    text-align: center;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    background: var(--surface);\n  }\n\n  .source-option-card:hover {\n    border-color: var(--primary-accent);\n    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.1);\n  }\n\n  .source-option-card.active {\n    border-color: var(--primary-accent);\n    background: rgba(14, 165, 233, 0.05);\n    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);\n  }\n\n  .source-icon {\n    font-size: 2.5rem;\n    margin-bottom: 0.75rem;\n  }\n\n  .source-title {\n    font-size: 1.1rem;\n    font-weight: 600;\n    color: var(--text-primary);\n    margin-bottom: 0.5rem;\n  }\n\n  .source-desc {\n    font-size: 0.85rem;\n    color: var(--text-secondary);\n  }\n\n  .form-range {\n    width: 100%;\n    height: 8px;\n    background: linear-gradient(to right, #ef4444 0%, #f59e0b 50%, #10b981 100%);\n    border-radius: 5px;\n    outline: none;\n    -webkit-appearance: none;\n    appearance: none;\n  }\n\n  .form-range::-webkit-slider-thumb {\n    -webkit-appearance: none;\n    appearance: none;\n    width: 24px;\n    height: 24px;\n    background: white;\n    border: 3px solid var(--primary-accent);\n    border-radius: 50%;\n    cursor: pointer;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);\n  }\n\n  .form-range::-moz-range-thumb {\n    width: 24px;\n    height: 24px;\n    background: white;\n    border: 3px solid var(--primary-accent);\n    border-radius: 50%;\n    cursor: pointer;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);\n  }\n</style>\n'

def block_content(context, missing=missing):
    resolve = context.resolve_or_missing
    undefined = environment.undefined
    concat = environment.concat
    cond_expr_undefined = Undefined
    if 0: yield None
    _block_vars = {}
    l_0_url_for = resolve('url_for')
    l_0_batches = resolve('batches')
    pass
    yield '\n<div class="form-container">\n  <div class="progress-header">\n    <div class="progress-title">\n      <h1>Bulk Screening Setup</h1>\n      <p>Konfigurasi dan jalankan batch screening terhadap sanction list</p>\n    </div>\n  </div>\n\n  <div class="form-card">\n    <div class="form-section-title">\n      <div class="form-section-icon">‚öôÔ∏è</div>\n      Konfigurasi Screening\n    </div>\n\n    <form method="post" action="'
    yield escape(context.call((undefined(name='url_for') if l_0_url_for is missing else l_0_url_for), 'web.screening_start', _block_vars=_block_vars))
    yield '" enctype="multipart/form-data" id="bulkScreeningForm">\n      <div class="form-group">\n        <label class="form-label">\n          Sumber Data Transaksi\n          <span class="label-required">*</span>\n        </label>\n        <div class="sanction-source-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-bottom: 1rem;">\n          <div class="source-option-card" onclick="selectTransactionSource(\'batch\')" id="sourceBatch">\n            <div class="source-icon">üíæ</div>\n            <div class="source-title">Gunakan Batch</div>\n            <div class="source-desc">Pakai transaksi yang sudah diupload</div>\n          </div>\n          <div class="source-option-card" onclick="selectTransactionSource(\'upload\')" id="sourceTransactionUpload">\n            <div class="source-icon">üì§</div>\n            <div class="source-title">Upload Baru</div>\n            <div class="source-desc">Upload file transaksi baru</div>\n          </div>\n        </div>\n        <input type="hidden" name="transaction_source" id="transactionSourceInput" value="batch">\n      </div>\n\n      <div id="batchSelectSection" style="display: block;">\n        <div class="form-group">\n          <label class="form-label">\n            Batch Transaksi\n            <span class="label-required">*</span>\n          </label>\n          <select name="batch_id" id="batchIdSelect" class="form-select">\n            <option value="">-- Pilih batch transaksi --</option>\n            '
    for l_1_b in (undefined(name='batches') if l_0_batches is missing else l_0_batches):
        _loop_vars = {}
        pass
        yield '\n              <option value="'
        yield escape(environment.getattr(l_1_b, 'id'))
        yield '"\n                      data-download-url="'
        yield escape(context.call((undefined(name='url_for') if l_0_url_for is missing else l_0_url_for), 'web.transaction_batch_download', batch_id=environment.getattr(l_1_b, 'id'), _loop_vars=_loop_vars))
        yield '"\n                      data-reimport-url="'
        yield escape(context.call((undefined(name='url_for') if l_0_url_for is missing else l_0_url_for), 'web.transaction_batch_reimport', batch_id=environment.getattr(l_1_b, 'id'), _loop_vars=_loop_vars))
        yield '">\n                #'
        yield escape(environment.getattr(l_1_b, 'id'))
        yield ' ‚Äî '
        yield escape(environment.getattr(l_1_b, 'filename'))
        yield ' ('
        yield escape(environment.getattr(l_1_b, 'row_count'))
        yield ' baris, '
        yield escape(environment.getattr(l_1_b, 'created_at'))
        yield ')\n              </option>\n            '
    l_1_b = missing
    yield '\n          </select>\n          <div class="form-text">Pilih batch transaksi yang ingin di-screening</div>\n\n          <div class="d-flex gap-2" style="margin-top: 0.75rem; flex-wrap: wrap;">\n            <a id="batchDownloadLink" class="btn btn-outline-secondary btn-sm disabled" href="#" tabindex="-1">Download File Batch</a>\n\n            <form id="batchReimportForm" method="post" action="#" style="display: inline;">\n              <input type="hidden" name="created_by" value="">\n              <button type="submit" class="btn btn-outline-primary btn-sm" disabled onclick="return confirm(\'Re-import akan membuat batch baru dari file yang tersimpan. Lanjutkan?\');">Re-import (buat batch baru)</button>\n            </form>\n          </div>\n        </div>\n      </div>\n\n      <div id="transactionUploadSection" style="display: none;">\n        <div class="form-group">\n          <label class="form-label">\n            File Transaksi\n            <span class="label-required">*</span>\n          </label>\n          <div class="file-upload-area" onclick="document.getElementById(\'transactionFileInput\').click();">\n            <div class="file-upload-icon">üìä</div>\n            <div class="file-upload-text">Upload file batch transaksi</div>\n            <div class="file-upload-hint">Format: TXT, CSV (Max 100MB)</div>\n            <input type="file" id="transactionFileInput" name="transaction_file" accept=".txt,.csv" onchange="updateFileName(this, \'transactionFileName\')">\n          </div>\n          <div id="transactionFileName" style="margin-top: 0.75rem; color: var(--text-secondary); font-size: 0.9rem;"></div>\n        </div>\n      </div>\n\n      <div class="form-group" style="margin-top: 2rem;">\n        <label class="form-label">Ambang Batas Skor Nama</label>\n        <div class="threshold-group">\n          <div class="threshold-input-row">\n            <input type="range" name="threshold_name_score" id="nameScoreSlider" class="form-range" value="70" min="0" max="100" \n                   oninput="updateThresholdDisplay(this.value, \'nameDisplay\', \'nameRecommendation\')">\n            <div class="threshold-value-display" id="nameDisplay">70%</div>\n          </div>\n          <div class="form-text">\n            Skor minimum kesamaan nama untuk dipertimbangkan. Range: 0-100%\n          </div>\n          <div id="nameRecommendation" class="threshold-recommendation">\n            <strong>Rekomendasi:</strong> Threshold moderat untuk screening balanced\n          </div>\n        </div>\n      </div>\n\n      <div class="form-group">\n        <label class="form-label">Ambang Batas Skor Akhir</label>\n        <div class="threshold-group">\n          <div class="threshold-input-row">\n            <input type="range" name="threshold_score" id="finalScoreSlider" class="form-range" value="60" min="0" max="100" \n                   oninput="updateThresholdDisplay(this.value, \'finalDisplay\', \'finalRecommendation\')">\n            <div class="threshold-value-display" id="finalDisplay">60%</div>\n          </div>\n          <div class="form-text">\n            Skor gabungan minimum (nama + DOB + kewarganegaraan) agar dianggap potensial match\n          </div>\n          <div id="finalRecommendation" class="threshold-recommendation">\n            <strong>Rekomendasi:</strong> Threshold moderat untuk screening balanced\n          </div>\n        </div>\n      </div>\n\n      <div class="form-group">\n        <label class="form-label">\n          Nama Petugas\n          <span class="label-optional">(Opsional)</span>\n        </label>\n        <input type="text" id="createdByInput" name="created_by" class="form-control" placeholder="Nama petugas yang menjalankan screening">\n        <div class="form-text">Untuk audit trail dan pencatatan petugas</div>\n      </div>\n\n      <div class="info-box" style="margin-top: 1.5rem;">\n        <strong>Catatan Penting:</strong>\n        <ul style="margin-bottom: 0;">\n          <li>Screening akan menggunakan sanction list yang tersimpan di database</li>\n          <li>Proses screening akan dimulai langsung setelah submit</li>\n          <li>Anda akan diarahkan ke halaman Jobs untuk memantau progress</li>\n        </ul>\n      </div>\n\n      <div id="uploadProgressContainer" style="display: none; margin-bottom: 1.5rem;">\n        <div class="d-flex justify-content-between mb-1">\n          <span id="progressStatusLabel" class="text-muted small fw-bold">Mengupload ke Server...</span>\n          \n          <span id="progressPercentText" class="text-primary small fw-bold">0%</span>\n        </div>\n        <div class="progress" style="height: 12px;">\n          <div id="uploadProgressBar" \n               class="progress-bar progress-bar-striped progress-bar-animated" \n               role="progressbar" \n               style="width: 0%">\n          </div>\n        </div>\n        <div id="progressWarning" class="form-text text-warning small mt-2">\n          ‚ö†Ô∏è Jangan tutup atau refresh halaman ini sampai proses selesai.\n        </div>\n      </div>\n      \n      <div class="form-actions">\n        <a href="'
    yield escape(context.call((undefined(name='url_for') if l_0_url_for is missing else l_0_url_for), 'web.index', _block_vars=_block_vars))
    yield '" class="btn btn-cancel">Batal</a>\n        <button type="button" class="btn btn-primary" id="submitBtn">Mulai Screening</button>\n      </div>\n    </form>\n  </div>\n</div>\n\n<script>\n  let simulationInterval;\n  let uploadedBatchId = null;\n  const uploadOnlyUrl = "'
    yield escape(context.call((undefined(name='url_for') if l_0_url_for is missing else l_0_url_for), 'web.transaction_batch_upload', _block_vars=_block_vars))
    yield '";\n\n  function selectTransactionSource(source) {\n    document.getElementById(\'sourceBatch\').classList.remove(\'active\');\n    document.getElementById(\'sourceTransactionUpload\').classList.remove(\'active\');\n    document.getElementById(\'transactionSourceInput\').value = source;\n    \n    if (source === \'batch\') {\n      document.getElementById(\'sourceBatch\').classList.add(\'active\');\n      document.getElementById(\'batchSelectSection\').style.display = \'block\';\n      document.getElementById(\'transactionUploadSection\').style.display = \'none\';\n      document.getElementById(\'batchIdSelect\').setAttribute(\'required\', \'required\');\n      document.getElementById(\'transactionFileInput\').removeAttribute(\'required\');\n\n      const submitBtn = document.getElementById(\'submitBtn\');\n      if (submitBtn) submitBtn.innerHTML = \'Mulai Screening\';\n    } else {\n      document.getElementById(\'sourceTransactionUpload\').classList.add(\'active\');\n      document.getElementById(\'batchSelectSection\').style.display = \'none\';\n      document.getElementById(\'transactionUploadSection\').style.display = \'block\';\n      document.getElementById(\'batchIdSelect\').removeAttribute(\'required\');\n      document.getElementById(\'transactionFileInput\').setAttribute(\'required\', \'required\');\n\n      const submitBtn = document.getElementById(\'submitBtn\');\n      if (submitBtn) submitBtn.innerHTML = \'Upload File\';\n    }\n  }\n\n  function updateBatchActions() {\n    const sel = document.getElementById(\'batchIdSelect\');\n    const link = document.getElementById(\'batchDownloadLink\');\n    const form = document.getElementById(\'batchReimportForm\');\n    if (!sel || !link || !form) return;\n\n    const opt = sel.options[sel.selectedIndex];\n    const downloadUrl = opt ? opt.getAttribute(\'data-download-url\') : \'\';\n    const reimportUrl = opt ? opt.getAttribute(\'data-reimport-url\') : \'\';\n\n    const btn = form.querySelector(\'button[type="submit"]\');\n    const createdByInput = document.getElementById(\'createdByInput\');\n    const createdByVal = createdByInput ? (createdByInput.value || \'\') : \'\';\n    const formCreatedBy = form.querySelector(\'input[name="created_by"]\');\n    if (formCreatedBy) formCreatedBy.value = createdByVal;\n\n    if (downloadUrl) {\n      link.href = downloadUrl;\n      link.classList.remove(\'disabled\');\n      link.removeAttribute(\'tabindex\');\n    } else {\n      link.href = \'#\';\n      link.classList.add(\'disabled\');\n      link.setAttribute(\'tabindex\', \'-1\');\n    }\n\n    if (reimportUrl) {\n      form.action = reimportUrl;\n      if (btn) btn.disabled = false;\n    } else {\n      form.action = \'#\';\n      if (btn) btn.disabled = true;\n    }\n  }\n\n  document.addEventListener(\'DOMContentLoaded\', () => {\n    const sel = document.getElementById(\'batchIdSelect\');\n    if (sel) {\n      sel.addEventListener(\'change\', updateBatchActions);\n      updateBatchActions();\n    }\n    const createdBy = document.getElementById(\'createdByInput\');\n    if (createdBy) createdBy.addEventListener(\'input\', updateBatchActions);\n  });\n\n  function updateFileName(input, displayId) {\n    const fileNameDisplay = document.getElementById(displayId);\n    if (input.files && input.files[0]) {\n      fileNameDisplay.textContent = \'‚úì \' + input.files[0].name + \' (\' + (input.files[0].size / 1024 / 1024).toFixed(2) + \' MB)\';\n      fileNameDisplay.style.color = \'var(--success)\';\n\n      // Show a clear status immediately after choosing a file.\n      const progressContainer = document.getElementById(\'uploadProgressContainer\');\n      const progressBar = document.getElementById(\'uploadProgressBar\');\n      const progressText = document.getElementById(\'progressPercentText\');\n      const statusLabel = document.getElementById(\'progressStatusLabel\');\n      if (progressContainer && progressBar && progressText && statusLabel) {\n        progressContainer.style.display = \'block\';\n        progressBar.classList.remove(\'bg-success\');\n        progressBar.classList.add(\'bg-primary\');\n        progressBar.style.width = \'0%\';\n        progressText.textContent = \'0%\';\n        statusLabel.textContent = \'File dipilih. Klik "Upload File" untuk mulai upload...\';\n        statusLabel.classList.remove(\'text-success\');\n      }\n    }\n  }\n\n  function startUploadOnly() {\n    // UI Setup Phase 1 (Upload)\n    const progressContainer = document.getElementById(\'uploadProgressContainer\');\n    const progressBar = document.getElementById(\'uploadProgressBar\');\n    const progressText = document.getElementById(\'progressPercentText\');\n    const submitBtn = document.getElementById(\'submitBtn\');\n    const statusLabel = document.getElementById(\'progressStatusLabel\');\n    const fileInput = document.getElementById(\'transactionFileInput\');\n\n    if (!fileInput || !fileInput.files || !fileInput.files[0]) {\n      alert(\'Pilih file transaksi terlebih dahulu.\');\n      return;\n    }\n\n    if (progressContainer) progressContainer.style.display = \'block\';\n    if (submitBtn) {\n      submitBtn.disabled = true;\n      submitBtn.innerHTML = \'Mengupload File...\';\n    }\n\n    // Reset UI\n    if (progressBar) {\n      progressBar.classList.remove(\'bg-success\');\n      progressBar.classList.add(\'bg-primary\');\n    }\n    if (statusLabel) {\n      statusLabel.textContent = \'Mengupload ke Server...\';\n      statusLabel.classList.remove(\'text-success\');\n    }\n\n    // Upload-only payload\n    const formData = new FormData();\n    formData.append(\'transaction_file\', fileInput.files[0]);\n    const createdByInput = document.getElementById(\'createdByInput\');\n    if (createdByInput && createdByInput.value) formData.append(\'created_by\', createdByInput.value);\n\n    const xhr = new XMLHttpRequest();\n\n    xhr.upload.addEventListener(\'progress\', function(evt) {\n      if (!evt.lengthComputable) return;\n      const percentComplete = Math.round((evt.loaded / evt.total) * 100);\n\n      const loadedMb = (evt.loaded / 1024 / 1024).toFixed(2);\n      const totalMb = (evt.total / 1024 / 1024).toFixed(2);\n      if (statusLabel) statusLabel.textContent = `Mengupload ke Server... (${loadedMb} / ${totalMb} MB)`;\n\n      if (progressBar) progressBar.style.width = percentComplete + \'%\';\n      if (progressText) progressText.textContent = percentComplete + \'%\';\n\n      if (percentComplete >= 100) {\n        startDBSimulation();\n      }\n    }, false);\n\n    xhr.addEventListener(\'load\', function() {\n      clearInterval(simulationInterval);\n\n      if (xhr.status >= 200 && xhr.status < 400) {\n        if (progressBar) {\n          progressBar.style.width = \'100%\';\n          progressBar.classList.remove(\'bg-primary\');\n          progressBar.classList.add(\'bg-success\');\n        }\n        if (progressText) progressText.textContent = \'100%\';\n\n        let resp = null;\n        try { resp = JSON.parse(xhr.responseText || \'{}\'); } catch (e) { resp = null; }\n        const newBatchId = resp && resp.batch_id ? String(resp.batch_id) : null;\n        if (!newBatchId) {\n          alert(\'Upload berhasil, tapi respon batch_id tidak ditemukan.\');\n          resetUploadUI();\n          return;\n        }\n\n        uploadedBatchId = newBatchId;\n        if (statusLabel) statusLabel.textContent = `Upload selesai. Batch #${newBatchId} siap diproses. Klik "Mulai Screening" untuk menjalankan.`;\n\n        // Ensure dropdown has the new batch option and is selected\n        const batchSelect = document.getElementById(\'batchIdSelect\');\n        if (batchSelect) {\n          let opt = batchSelect.querySelector(`option[value="${newBatchId}"]`);\n          if (!opt) {\n            opt = document.createElement(\'option\');\n            opt.value = newBatchId;\n            opt.textContent = `#${newBatchId} ‚Äî ${(resp.filename || \'Upload Baru\')} (${resp.row_count || 0} baris)`;\n            opt.setAttribute(\'data-download-url\', resp.download_url || `/transactions/batches/${newBatchId}/download`);\n            opt.setAttribute(\'data-reimport-url\', resp.reimport_url || `/transactions/batches/${newBatchId}/reimport`);\n            batchSelect.insertBefore(opt, batchSelect.options[1] || null);\n          }\n          batchSelect.value = newBatchId;\n        }\n\n        // Switch to batch mode for the next step\n        document.getElementById(\'transactionSourceInput\').value = \'batch\';\n        selectTransactionSource(\'batch\');\n        updateBatchActions();\n\n        if (submitBtn) {\n          submitBtn.disabled = false;\n          submitBtn.innerHTML = \'Mulai Screening\';\n        }\n      } else {\n        alert(\'Gagal upload/proses: \' + (xhr.statusText || (\'HTTP \' + xhr.status)));\n        resetUploadUI();\n      }\n    });\n\n    xhr.addEventListener(\'error\', function() {\n      clearInterval(simulationInterval);\n      alert(\'Terjadi kesalahan jaringan.\');\n      resetUploadUI();\n    });\n\n    xhr.open(\'POST\', uploadOnlyUrl);\n    xhr.send(formData);\n\n    function resetUploadUI() {\n      clearInterval(simulationInterval);\n      if (submitBtn) {\n        submitBtn.disabled = false;\n        submitBtn.innerHTML = \'Upload File\';\n      }\n      if (progressBar) progressBar.style.width = \'0%\';\n      if (progressText) progressText.textContent = \'0%\';\n    }\n  }\n\n  function startScreeningSubmit() {\n    const form = document.getElementById(\'bulkScreeningForm\');\n    const batchSelect = document.getElementById(\'batchIdSelect\');\n    const sourceInput = document.getElementById(\'transactionSourceInput\');\n\n    if (!form || !batchSelect || !sourceInput) return;\n\n    // If user uploaded but dropdown wasn\'t set (defensive), set it.\n    if ((!batchSelect.value || batchSelect.value === \'\') && uploadedBatchId) {\n      batchSelect.value = String(uploadedBatchId);\n    }\n\n    if (!batchSelect.value) {\n      alert(\'Pilih batch transaksi terlebih dahulu.\');\n      return;\n    }\n\n    sourceInput.value = \'batch\';\n    // Submit normal POST to /screening/start\n    form.submit();\n  }\n\n  // --- FUNGSI SIMULASI PROGRESS DB ---\n  function startDBSimulation() {\n    const progressBar = document.getElementById(\'uploadProgressBar\');\n    const progressText = document.getElementById(\'progressPercentText\');\n    const statusLabel = document.getElementById(\'progressStatusLabel\');\n    const submitBtn = document.getElementById(\'submitBtn\');\n\n    // 1. Ubah Status UI\n    statusLabel.textContent = \'Menyimpan & Memproses Data di Database...\';\n    statusLabel.classList.add(\'text-success\');\n    submitBtn.innerHTML = \'<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memproses Database...\';\n    \n    // Ganti warna bar jadi hijau (Processing state)\n    progressBar.classList.remove(\'bg-primary\');\n    progressBar.classList.add(\'bg-success\');\n    \n    // 2. Reset Bar ke 0 untuk fase baru (Processing)\n    let fakeProgress = 0;\n    progressBar.style.width = \'0%\';\n    progressText.textContent = \'0%\';\n\n    // 3. Jalankan Animasi Fake Progress\n    // Trik: Cepat di awal, melambat di akhir (Logarithmic like)\n    simulationInterval = setInterval(() => {\n        // Logika perlambatan: makin tinggi persen, makin kecil penambahannya\n        let increment = 0;\n        if (fakeProgress < 30) increment = 5;       // 0-30%: Cepat\n        else if (fakeProgress < 60) increment = 2;  // 30-60%: Sedang\n        else if (fakeProgress < 85) increment = 0.5;// 60-85%: Pelan\n        else if (fakeProgress < 95) increment = 0.1;// 85-95%: Sangat pelan (Menunggu server)\n        \n        // Mentok di 95% sampai server beneran response\n        if (fakeProgress + increment < 95) {\n            fakeProgress += increment;\n        }\n\n        progressBar.style.width = fakeProgress + \'%\';\n        progressText.textContent = Math.round(fakeProgress) + \'%\';\n    }, 500); // Update tiap setengah detik\n  }\n\n  document.addEventListener(\'DOMContentLoaded\', function () {\n    selectTransactionSource(\'batch\');\n\n    const submitBtn = document.getElementById(\'submitBtn\');\n    if (!submitBtn) return;\n\n    submitBtn.addEventListener(\'click\', function() {\n      const source = document.getElementById(\'transactionSourceInput\').value;\n      if (source === \'upload\') {\n        startUploadOnly();\n        return;\n      }\n      // batch mode\n      startScreeningSubmit();\n    });\n  });\n</script>\n'

blocks = {'head': block_head, 'content': block_content}
debug_info = '1=12&3=17&346=27&361=38&390=40&391=44&392=46&393=48&394=50&498=60&508=62'